import{_ as e,c as t,o as s,d as a}from"./app.d643be22.js";const n="/me/assets/tdd-red-green-refactoring-v3.ac56d425.png",y=JSON.parse('{"title":"Testing and Mocking with Laravel","description":"","frontmatter":{},"headers":[{"level":2,"title":"Personal note about Automatized Tests - Feature/Unit/Integrated Tests","slug":"personal-note-about-automatized-tests-feature-unit-integrated-tests","link":"#personal-note-about-automatized-tests-feature-unit-integrated-tests","children":[]},{"level":2,"title":"Testing external services","slug":"testing-external-services","link":"#testing-external-services","children":[]}],"relativePath":"posts/2022/testing-and-mocking-with-laravel.md"}'),o={name:"posts/2022/testing-and-mocking-with-laravel.md"},i=a('<h1 id="testing-and-mocking-with-laravel" tabindex="-1">Testing and Mocking with Laravel <a class="header-anchor" href="#testing-and-mocking-with-laravel" aria-hidden="true">#</a></h1><h2 id="personal-note-about-automatized-tests-feature-unit-integrated-tests" tabindex="-1">Personal note about Automatized Tests - Feature/Unit/Integrated Tests <a class="header-anchor" href="#personal-note-about-automatized-tests-feature-unit-integrated-tests" aria-hidden="true">#</a></h2><p>Before all, let&#39;s talk a little bit about the important of automatized tests in our work.</p><p>To be honest, I don&#39;t know how I lived before without this. I spent a long time testing the things manually, broking the old codes, etc. And, maybe the worst, thinking wrong. I&#39;ll to explain.</p><p>When you do your test about something, you have the opportunity to really to think about the design of your real code, because you need do it simple, re-usable and with less dependences.</p><p>If you try do you test as TDD, making your test first and just after write your real code. Improving and testing again, it&#39;s so more easly do a refactor in &#39;task time&#39;, keeping less issues to the future.</p><p><img src="'+n+`" alt="Image of TDD - IBM"></p><p>I get this image from this awesome IBM Article <a href="https://developer.ibm.com/articles/5-steps-of-test-driven-development/" target="_blank" rel="noreferrer">5 steps of test-driven development</a></p><p>Here, I&#39;ll put my personal good points about, why we need write tests:</p><ul><li>Help to do make good deliveries;</li><li>Can to refactor without fear;</li><li>Improve your code design - your test is the first &#39;customer&#39; of your implementation;</li><li>Improve your code design - you will to think better to make your code easily to be tested;</li><li>If you to write one test for each new bug foun, maybe you never more will take the same bugs.</li></ul><h2 id="testing-external-services" tabindex="-1">Testing external services <a class="header-anchor" href="#testing-external-services" aria-hidden="true">#</a></h2><p>Working with micro-services or external services integrated, sometimes we need to simulate the behavior of some resources, for example, HTTP calls. The mock is a way to simulate this and ensure the quality of your feature without to need the external resource inside your test.</p><p>Let&#39;s to say that you have a integration with Stripe Payments and you need to test your software but don&#39;t want to create a new customer or new billings every time when you run your tests. To do it, we need mock the Stripe behavior.</p><p>In my example, I&#39;m using the Cashier to abstract the Stripe things, because this, I created a Service called PremiumService to abstract the Cashier functions and I mocked just the PremiumService.</p><p>To simplify our life, I like to create the mocks inside some Trait to just &#39;enable&#39; inside my tests, like this:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">&lt;?php</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">namespace Tests\\Traits;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">use App\\Services\\PremiumService;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">trait StripeMock</span></span>
<span class="line"><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    public function setStripeMock()</span></span>
<span class="line"><span style="color:#A6ACCD;">    {</span></span>
<span class="line"><span style="color:#A6ACCD;">        $this-&gt;mock(PremiumService::class, function ($mock) {</span></span>
<span class="line"><span style="color:#A6ACCD;">            $mock-&gt;shouldReceive(&#39;createAsStripeCustomer&#39;)-&gt;andReturn();</span></span>
<span class="line"><span style="color:#A6ACCD;">            $mock-&gt;shouldReceive(&#39;cancelProductSubscription&#39;)-&gt;andReturn();</span></span>
<span class="line"><span style="color:#A6ACCD;">            $mock-&gt;shouldReceive(&#39;createStripeSubscription&#39;)-&gt;andReturn($mock);</span></span>
<span class="line"><span style="color:#A6ACCD;">            $mock-&gt;shouldReceive(&#39;getActiveSubscriptions&#39;)-&gt;andReturn([</span></span>
<span class="line"><span style="color:#A6ACCD;">                [&#39;id&#39; =&gt; 12, &#39;name&#39; =&gt; &#39;sub&#39;, &#39;items&#39; =&gt; [[&#39;id&#39; =&gt; 21]]],</span></span>
<span class="line"><span style="color:#A6ACCD;">            ]);</span></span>
<span class="line"><span style="color:#A6ACCD;">        })-&gt;makePartial();</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>With this, inside my tests of stripe, I just need need import the Trait and run <code>$this-&gt;setStripeMock();</code> to &#39;enable&#39; mock.</p><p>Let&#39;s to try understand the mock now.</p><p>In the first mock line <code>$this-&gt;mock(PremiumService::class, function ($mock)</code> we are creating the simulation of <code>PremiumService</code>, this way when the application initiate the Class, the mock will be used instead of real Class.</p><p>Inside of mock, we have defined the behavior about each method, like:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">$mock-&gt;shouldReceive(&#39;createAsStripeCustomer&#39;)-&gt;andReturn();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>It means that when call the method <code>createAsStripeCustomer</code>, the return will be void as expected in real code. But if you check the <code>getActiveSubscriptions</code>, we have a simple data returning simulating the original behavior.</p><p>To clarify more, the PremiumService is just one Class to abstract the <code>Cashier</code> methods, like this:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">// PremiumService</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">public function getActiveSubscriptions(Company $company)</span></span>
<span class="line"><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    return $company-&gt;subscriptions()-&gt;active()-&gt;get();</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><hr><p>Here you can lean more about tests, I listed some good articles to help you:</p><p><a href="https://ralphjsmit.com/laravel-mock-dependencies" target="_blank" rel="noreferrer">https://ralphjsmit.com/laravel-mock-dependencies</a></p><p><a href="https://5balloons.info/how-to-mock-objects-in-phpunit-pest-tests-in-laravel" target="_blank" rel="noreferrer">https://5balloons.info/how-to-mock-objects-in-phpunit-pest-tests-in-laravel</a></p><p><a href="https://medium.com/the-andela-way/mock-testing-in-laravel-4a2fe15885b8" target="_blank" rel="noreferrer">https://medium.com/the-andela-way/mock-testing-in-laravel-4a2fe15885b8</a></p>`,29),l=[i];function r(p,c,d,u,h,m){return s(),t("div",null,l)}const C=e(o,[["render",r]]);export{y as __pageData,C as default};
